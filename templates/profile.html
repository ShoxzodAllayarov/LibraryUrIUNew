{% extends 'layouts/base.html' %}
{% load static %}

{% block body %}
<body data-scroll-animation="true">
    <div id="preloader">
        <div id="ctn-preloader" class="ctn-preloader">
            <div class="round_spinner">
                <div class="spinner"></div>
                <div class="text">
                    <img src="{% static 'img/header_logo.png' %}" alt="Image">
                    <h4><span>UrIU</span></h4>
                </div>
            </div>
            <p></p>
        </div>
    </div>

    <div class="body_wrapper">
        <div class="toast-container position-fixed p-3">
            <div id="cartToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Cart Update</strong>
                    <small>just now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    Item added to the cart!
                </div>
            </div>
        </div>


        <!-- Modal -->
        <div class="modal fade product-quickview-modal" id="productQuickView" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog  modal-dialog-centered">
                <div class="modal-content">
                    <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close"><i
                            class="icon_close"></i></button>
                    <div class="bj_book_single">
                        <div class="bj_book_img flip">
                            <div class="front"><img class="img-fluid" src="{% static 'assets/img/book-single1.jpg' %}"
                                    alt="">
                            </div>
                            <div class="back"><img class="img-fluid" src="{% static 'assets/img/book-single.jpg' %}"
                                    alt=""></div>
                            <div class="pr_ribbon">
                                <span class="product-badge">New</span>
                            </div>
                        </div>
                        <div class="bj_book_details">
                            <h2>A Storytelling Workbook</h2>
                            <ul class="list-unstyled book_meta">
                                <li>By:<a href="author-single.html">Phillip Siphron</a></li>
                                <li>Category:<a href="shop-sidebar.html">Drama</a></li>
                                <li>Tag:<a href="shop-sidebar.html">Best Sellers</a></li>
                            </ul>
                            <div class="ratting review">
                                <div class="star-rating">
                                    <span>4.9</span>
                                </div>
                                <a href="#product_review" class="woocommerce-review-link">
                                    <span class="count"> 50 </span>Reviews
                                </a>
                            </div>
                            <div class="price">$10</div>
                            <p>Dicta sunt explicabo. Nemo enim ipsam voluptatem voluptas sit odit aut fugit, sed
                                quia consequuntur.</p>
                            <ul class="product_meta list-unstyled">
                                <li><span>Publisher:</span>Avery</li>
                                <li><span>Publication date:</span>July 20, 2024</li>
                                <li><span>Print length:</span>320 pages</li>
                                <li><span>ISBN:</span>3288365629</li>
                                <li><span>Language:</span>English</li>
                            </ul>
                            <div class="product_sidbar">
                                <div class="product-qty">
                                    Qty:
                                    <div class="cart_quantity">
                                        <button class="quantity_btn minus"><i class="icon_minus-06"></i></button>
                                        <input type="number" min="1" max="99" step="1" value="1">
                                        <button class="quantity_btn plus"><i class="icon_plus"></i></button>
                                    </div>
                                </div>

                                <div class="single_product_price_variation mb-3">
                                    <label class="variation_single">
                                        <input class="variation_single_input" name="variation_single" type="radio"
                                            checked>
                                        <span class="price-details">
                                            <span class="price-type">Handcover</span>
                                            <span class="price-cost">$10</span>
                                        </span>
                                    </label>
                                    <label class="variation_single">
                                        <input class="variation_single_input" name="variation_single" type="radio">
                                        <span class="price-details">
                                            <span class="price-type">eBook</span>
                                            <span class="price-cost">$20</span>
                                        </span>
                                    </label>
                                    <label class="variation_single">
                                        <input class="variation_single_input" name="variation_single" type="radio">
                                        <span class="price-details">
                                            <span class="price-type">Print</span>
                                            <span class="price-cost">$30</span>
                                        </span>
                                    </label>

                                </div>
                                <div class="d-flex flex-column gap-2">
                                    <a href="checkout.html" class="bj_theme_btn"> Buy Now</a>
                                    <button class="bj_theme_btn add-to-cart-automated" type="button"
                                        data-name="A Storytelling Workbook" data-price="10"
                                        data-img="assets/img/book-single1.jpg' %}" data-mrp="15"> <i
                                            class="icon_cart_alt"></i>Add to
                                        cart</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% include 'layouts/header.html' %}

<div class="container " style="margin-top: 100px;">
    <h2 class="text-center">Meninga profilim</h2>

    <!-- ✅ Блок вывода сообщений -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-md-4 text-center">
            <img src="{{ user.profile_picture.url }}" alt="Фото профиля" class="rounded-circle img-fluid"
                 width="200" height="200" onerror="this.src='{% static 'assets/img/default_user.png' %}';">
        </div>

        <div class="col-md-8">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label">Profil rasmi</label>
                    <input type="file" name="profile_picture" class="form-control">
                </div>

                <div class="mb-3">
                    <label class="form-label">Telefon raqami</label>
                    <input type="text" name="phone" class="form-control" value="{{ user.phone }}">
                </div>

                <button type="submit" class="btn btn-success">Saqlash</button>
            </form>
        </div>
    </div>

    <h3 class="mt-5">Men olgan kitoblar</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Kitob</th>
                <th>Olish sanasi</th>
                <th>Qaytarish sanasi</th>
                <th>Holati</th>
            </tr>
        </thead>
        <tbody>
            {% for record in borrow_records %}
            <tr>
                <td>{{ record.book.title }}</td>
                <td>{{ record.borrow_date|date:"d.m.Y" }}</td>
                <td>{{ record.return_date|date:"d.m.Y" }}</td>
                <td>
                    {% if record.is_confirmed %}
                        {% if record.is_returned %}
                            ✅ Qaytarilgan
                        {% else %}
                            ❌ Qaytarilmagan
                        {% endif %}
                    {% else %}
                        <button class="btn btn-primary btn-sm confirm-btn" data-record-id="{{ record.id }}">Tasdiqlash</button>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center">Siz hali kitob olmadingiz</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- AJAX Skript -->
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".confirm-btn").forEach(button => {
            button.addEventListener("click", function() {
                let recordId = this.getAttribute("data-record-id");
                let buttonElement = this;
    
                fetch("{% url 'confirm_borrow' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({ "record_id": recordId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        buttonElement.outerHTML = "✅ Tasdiqlandi";
                    } else {
                        alert("Xatolik: " + data.error);
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        });
    });
    </script>
    
</div>
{% include 'layouts/footer.html' %}
</div>
<!-- Back to top button -->
<a id="back-to-top" title="Back to Top"></a>
<!-- Optional JavaScript; choose one of the two! -->
<script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>

<!-- Option 2: Separate Popper and Bootstrap JS -->

<script src="{% static 'assets/js/preloader.js' %}"></script>
<script src="{% static 'assets/vendors/bootstrap/js/popper.min.js' %}"></script>
<script src="{% static 'assets/vendors/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'assets/vendors/parallax/parallax.js' %}"></script>
<script src="{% static 'assets/vendors/isotope/imagesloaded.pkgd.min.js' %}"></script>
<script src="{% static 'assets/vendors/isotope/isotope.pkgd.min.js' %}"></script>
<script src="{% static 'assets/vendors/parallax/jquery.parallax-scroll.js' %}"></script>
<script src="{% static 'assets/vendors/wow/wow.min.js' %}"></script>
<script src="{% static 'assets/js/custom.js' %}"></script>

{% endblock %}
