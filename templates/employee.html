{% extends 'layouts/base.html' %}
{% load static %}

{% block body %}
{% include 'layouts/header.html' %}
{% if user.is_authenticated and user.is_staff %}
    <div class="container" style="margin-top: 150px;">
        <h2>Kitob berish</h2>

        <form id="borrow-form">
            <div class="mb-3">
                <label for="student" class="form-label">Student:</label>
                <select id="student" name="student_id" class="form-control select2">
                    <option value="">Student ma'lumotlarini kiriting.</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="book" class="form-label">Kitobni tanlang:</label>
                <select id="book" name="book_id" class="form-control select2">
                    <option value="">Kitob ma'lumotlarini kiriting.</option>
                </select>
            </div>

            <button type="button" id="borrow-button" class="btn btn-success" disabled>Berish</button>
        </form>

        <div id="message-box" class="mt-3"></div>

        <hr>

        <h2>Kitobni qaytarib olish</h2>

        <form id="return-form">
            <div class="mb-3">
                <label for="borrowed" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –æ –≤—ã–¥–∞—á–µ:</label>
                <select id="borrowed" name="borrow_id" class="form-control select2">
                    <option value="">–í–≤–µ–¥–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –∏–ª–∏ ISBN...</option>
                </select>
            </div>

            <button type="button" id="return-button" class="btn btn-danger" disabled>–í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É</button>
        </form>

        <div id="return-message-box" class="mt-3"></div>
    </div>
{% endif %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º jQuery –∏ Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Select2 —Å AJAX-–∑–∞–ø—Ä–æ—Å–æ–º
    function initSelect2(id, url, placeholder) {
        $(id).select2({
            ajax: {
                url: url,
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return { q: params.term || '' };
                },
                processResults: function (data) {
                    return { results: data.results };
                },
                cache: true
            },
            minimumInputLength: 0,
            placeholder: placeholder,
            allowClear: true
        });
    }

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–µ–ª–µ–∫—Ç—ã
    initSelect2('#student', "{% url 'search_students' %}", "–í–≤–µ–¥–∏—Ç–µ –∏–º—è, –ª–æ–≥–∏–Ω –∏–ª–∏ ID —Å—Ç—É–¥–µ–Ω—Ç–∞...");
    initSelect2('#book', "{% url 'search_books' %}", "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä–∞, ISBN –∏–ª–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥...");
    initSelect2('#borrowed', "{% url 'search_borrowed_books' %}", "–í–≤–µ–¥–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –∏–ª–∏ ISBN...");

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫
    function checkSelection() {
        $('#borrow-button').prop('disabled', !($('#student').val() && $('#book').val()));
        $('#return-button').prop('disabled', !$('#borrowed').val());
    }

    $('#student, #book, #borrowed').on('change', checkSelection);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–¥–∞—á—É –∫–Ω–∏–≥–∏
    $('#borrow-button').click(function() {
        $.ajax({
            url: "{% url 'borrow_book' %}",
            type: "POST",
            data: {
                student_id: $('#student').val(),
                book_id: $('#book').val(),
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
            success: function(response) {
                $('#message-box').html('<div class="alert alert-success">' + response.message + '</div>');
                $('#student, #book').val(null).trigger('change'); // –û—á–∏—â–∞–µ–º select
                $('#borrow-button').prop('disabled', true);
            },
            error: function(xhr) {
                let errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ –∫–Ω–∏–≥–∏";
                $('#message-box').html('<div class="alert alert-danger">' + errorMsg + '</div>');
            }
        });
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –∫–Ω–∏–≥–∏
    $('#return-button').click(function() {
        $.ajax({
            url: "{% url 'return_book' %}",
            type: "POST",
            data: {
                borrow_id: $('#borrowed').val(),
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
            success: function(response) {
                $('#return-message-box').html('<div class="alert alert-success">' + response.message + '</div>');
                $('#borrowed').val(null).trigger('change');
                $('#return-button').prop('disabled', true);
            },
            error: function(xhr) {
                let errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫–Ω–∏–≥–∏";
                $('#return-message-box').html('<div class="alert alert-danger">' + errorMsg + '</div>');
            }
        });
    });
});
</script>
<!--  -->
<div class="container" style="margin-top: 50px;">
    <h2>Berilgan kitoblarni statuslari</h2>

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-returned-tab" data-bs-toggle="pill" data-bs-target="#pills-returned"
                type="button" role="tab">‚úÖ Qaytarilgan</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-borrowed-tab" data-bs-toggle="pill" data-bs-target="#pills-borrowed"
                type="button" role="tab">üìö Berilgan</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-pending-tab" data-bs-toggle="pill" data-bs-target="#pills-pending"
                type="button" role="tab">‚è≥ Tasdiqlanmoqda</button>
        </li>
    </ul>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tab-content" id="pills-tabContent">
        <!-- ‚úÖ –í–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ -->
        <div class="tab-pane fade show active" id="pills-returned" role="tabpanel">
            <div class="row">
                {% for record in returned_books %}
                <div class="col-lg-4 col-sm-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">{{ record.book.title }}</h5>
                            <p class="card-text"><strong>Student:</strong> {{ record.user.full_name }}</p>
                            <p class="card-text"><strong>Berilgan sana:</strong> {{ record.borrow_date|date:"d.m.Y" }}</p>
                            <p class="card-text"><strong>Qaytarilgan sana:</strong> {{ record.return_date|date:"d.m.Y" }}</p>
                            <p class="card-text"><strong>Telefon raqami:</strong> {{ record.user.phone }}</p>
                            <p class="card-text"><strong>Hemis:</strong> <a href="{{ record.user.validate_url }}" style="text-decoration: underline; color: blue;">Ma'lumotlarini tekshirish</a></p>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>qaytarilgan kitoblar topilmadi.</p>
                {% endfor %}
            </div>
        </div>

        <!-- üìö –í—ã–¥–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ -->
        <div class="tab-pane fade" id="pills-borrowed" role="tabpanel">
            <div class="row">
                {% for record in borrowed_books %}
                <div class="col-lg-4 col-sm-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">{{ record.book.title }}</h5>
                            <p class="card-text"><strong>Student:</strong> {{ record.user.full_name }}</p>
                            <p class="card-text"><strong>Berilgan sana:</strong> {{ record.borrow_date|date:"d.m.Y" }}</p>
                            <p class="card-text text-danger">Kitob xali qaytarilmadi!</p>
                            <p class="card-text"><strong>Telefon raqami:</strong> {{ record.user.phone }}</p>
                            <p class="card-text"><strong>Hemis:</strong> <a href="{{ record.user.validate_url }}" style="text-decoration: underline; color: blue;">Ma'lumotlarini tekshirish</a></p>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>Berilgan kitoblar topilmadi</p>
                {% endfor %}
            </div>
        </div>

        <!-- ‚è≥ –û–∂–∏–¥–∞—é—â–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
        <div class="tab-pane fade" id="pills-pending" role="tabpanel">
            <div class="row">
                {% for record in pending_books %}
                <div class="col-lg-4 col-sm-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">{{ record.book.title }}</h5>
                            <p class="card-text"><strong>Student:</strong> {{ record.user.full_name }}</p>
                            <p class="card-text"><strong>Berilgan sana:</strong> {{ record.borrow_date|date:"d.m.Y" }}</p>
                            <p class="card-text text-warning">‚ö† Tasdiqlanishi kutilmoqda</p>
                            <p class="card-text"><strong>Telefon raqami:</strong> {{ record.user.phone }}</p>
                            <p class="card-text"><strong>Hemis:</strong> <a href="{{ record.user.validate_url }}" style="text-decoration: underline; color: blue;">Ma'lumotlarini tekshirish</a></p>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>Xech nima topilmadi.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap Tabs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<!--  -->

{% include 'layouts/footer.html' %}
{% endblock %}
